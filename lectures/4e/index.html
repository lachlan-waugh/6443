<!doctype html><html lang=en><head><meta charset=utf-8><title>x4 nosql/orm</title>
<meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black-translucent"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><link rel=stylesheet href=../../reveal-js/css/reset.css><link rel=stylesheet href=../../reveal-js/css/reveal.css><link rel=stylesheet href=../../reveal-js/css/theme/black.css id=theme><link rel=stylesheet href=../../highlight-js/default.min.css></head><body><div class=reveal><div class=slides><section><h2 id=well-get-started-at-2005->We&rsquo;ll get started at 20:05 (???)</h2></section><section data-noprocess data-shortcode-slide class=center><h2 id=further-database-exploitation>further database exploitation</h2><h3 id=6843-week4>6843 week4</h3></section><section><h2 id=i-think-therefore-i-shill>I think therefore I shill</h2><ul><li>do COMP6447</li><li>use GCP</li></ul></section><section><h3 id=overview>overview</h3><ul><li>orm injection</li><li>nosql injection</li></ul></section><section><section data-shortcode-section><h2 id=orm>ORM</h2><ul><li>object-relational model</li></ul></section><section><h3 id=what-is-an-orm>what is an ORM</h3><ul><li>an abstraction</li><li>allows you to interact with a database as if they were a library</li></ul></section><section><h3 id=how-do-they-work>how do they work</h3><ul><li>you define models representing database tables</li><li>under the hood all of these function calls will just generate SQL queries for you</li><li>essentially just prepared statements lol, but more confusing</li></ul></section><section><h3 id=example>example</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span>cursor <span style=color:#f92672>=</span> sqlite3<span style=color:#f92672>.</span>connect(<span style=color:#e6db74>&#34;example.db&#34;</span>)<span style=color:#f92672>.</span>cursor()
</span></span><span style=display:flex><span>cursor<span style=color:#f92672>.</span>execute(<span style=color:#e6db74>&#34;SELECT * FROM users WHERE age &gt; ?&#34;</span>, (<span style=color:#ae81ff>30</span>,))
</span></span><span style=display:flex><span>rows <span style=color:#f92672>=</span> cursor<span style=color:#f92672>.</span>fetchall()
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>User</span>(Base):
</span></span><span style=display:flex><span>    __tablename__ <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;users&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    id <span style=color:#f92672>=</span> Column(Integer, primary_key<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>    name <span style=color:#f92672>=</span> Column(String)
</span></span><span style=display:flex><span>    age <span style=color:#f92672>=</span> Column(Integer)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>session <span style=color:#f92672>=</span> sessionmaker(bind<span style=color:#f92672>=</span>create_engine(<span style=color:#e6db74>&#34;sqlite:///example.db&#34;</span>))()
</span></span><span style=display:flex><span>users <span style=color:#f92672>=</span> session<span style=color:#f92672>.</span>query(User)<span style=color:#f92672>.</span>filter(User<span style=color:#f92672>.</span>age <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>30</span>)<span style=color:#f92672>.</span>all()
</span></span></code></pre></div></section></section><section><section data-shortcode-section><h2 id=aside-abstraction-bad>aside: abstraction bad</h2><ul><li>there&rsquo;s now so many layers of code between the programmer and the computer</li></ul></section></section><section><section data-shortcode-section><h3 id=what-is-the-vulnerability-here>what is the vulnerability here</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span>query <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;SELECT * FROM users WHERE id = </span><span style=color:#e6db74>{</span>user_input<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>session<span style=color:#f92672>.</span>execute(query)
</span></span></code></pre></div></section><section><h3 id=how-to-fix>how to fix?</h3><p>yeah, basic sqli</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span><span style=color:#f92672>from</span> sqlalchemy <span style=color:#f92672>import</span> text
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>query <span style=color:#f92672>=</span> text(<span style=color:#e6db74>&#34;SELECT * FROM users WHERE id = :id&#34;</span>)
</span></span><span style=display:flex><span>session<span style=color:#f92672>.</span>execute(query, {<span style=color:#e6db74>&#34;id&#34;</span>: <span style=color:#ae81ff>1</span>})
</span></span></code></pre></div></section><section><h3 id=what-is-the-vulnerability-here-1>what is the vulnerability here</h3><p>I don&rsquo;t think this vulnerability has been covered yet, but idk gl</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span><span style=color:#f92672>from</span> flask <span style=color:#f92672>import</span> request
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>user <span style=color:#f92672>=</span> User(<span style=color:#f92672>**</span>request<span style=color:#f92672>.</span>json)
</span></span><span style=display:flex><span>session<span style=color:#f92672>.</span>add(user)
</span></span><span style=display:flex><span>session<span style=color:#f92672>.</span>commit()
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span>user <span style=color:#f92672>=</span> User<span style=color:#f92672>.</span>objects<span style=color:#f92672>.</span>filter(<span style=color:#f92672>**</span>request<span style=color:#f92672>.</span>json)
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> user
</span></span></code></pre></div></section><section><h3 id=how-to-fix-1>how to fix?</h3><p>yeah, its mass assignment</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span>user <span style=color:#f92672>=</span> User(
</span></span><span style=display:flex><span>    name<span style=color:#f92672>=</span>request<span style=color:#f92672>.</span>json<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;name&#34;</span>),
</span></span><span style=display:flex><span>    age<span style=color:#f92672>=</span>request<span style=color:#f92672>.</span>json<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;age&#34;</span>)
</span></span><span style=display:flex><span>)
</span></span></code></pre></div></section><section><h3 id=some-other-common-issues>some other common issues</h3><p><a href=https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/ORM%20Leak/README.md>payload-all-the-things</a></p></section><section><h3 id=cves>cves</h3><ul><li>we&rsquo;re not just attacking poor implementations/misconfigurations</li><li>you&rsquo;re now using someone elses code</li><li>this can introduce it&rsquo;s own vulnerablities</li><li>often these are open-source</li></ul></section><section><h3 id=the-underlying-issue>the underlying issue</h3><ul><li>orms are very good at simple queries, but aren&rsquo;t great at more complex logic</li><li>these models are still just generating and executing sql queries</li><li>programmers can make mistakes</li><li>e.g. this bug in <a href=https://github.com/sequelize/sequelize/issues/14519>sequelize</a>, also <a href=https://github.com/sequelize/sequelize/issues/6194>this one</a></li></ul></section><section><h3 id=fingerprinting>fingerprinting</h3><p>ye you can still do it</p></section></section><section><section data-shortcode-section><h2 id=nosql-injection>nosql injection</h2></section><section><h3 id=what-is-nosql>what is nosql</h3><ul><li>what it sounds like, not sql</li><li>a non-relational database, it&rsquo;s just a key-value store</li><li>honestly probably better for most use-cases</li><li>e.g. mongodb</li></ul></section><section><h3 id=examples>examples</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span>cursor <span style=color:#f92672>=</span> sqlite3<span style=color:#f92672>.</span>connect(<span style=color:#e6db74>&#34;example.db&#34;</span>)<span style=color:#f92672>.</span>cursor()
</span></span><span style=display:flex><span>cursor<span style=color:#f92672>.</span>execute(<span style=color:#e6db74>&#34;SELECT * FROM users WHERE age &gt; ?&#34;</span>, (<span style=color:#ae81ff>30</span>,))
</span></span><span style=display:flex><span>rows <span style=color:#f92672>=</span> cursor<span style=color:#f92672>.</span>fetchall()
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span><span style=color:#75715e># Connect to MongoDB</span>
</span></span><span style=display:flex><span>client <span style=color:#f92672>=</span> MongoClient(<span style=color:#e6db74>&#34;mongodb://localhost:27017/&#34;</span>)
</span></span><span style=display:flex><span>db <span style=color:#f92672>=</span> client[<span style=color:#e6db74>&#34;example_db&#34;</span>]
</span></span><span style=display:flex><span>users_collection <span style=color:#f92672>=</span> db[<span style=color:#e6db74>&#34;users&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Query users older than 30</span>
</span></span><span style=display:flex><span>users <span style=color:#f92672>=</span> users_collection<span style=color:#f92672>.</span>find({<span style=color:#e6db74>&#34;age&#34;</span>: {<span style=color:#e6db74>&#34;$gt&#34;</span>: <span style=color:#ae81ff>30</span>}})
</span></span></code></pre></div></section></section><section><section data-shortcode-section><h3 id=what-vulnerabilities-exist-in-nosql>what vulnerabilities exist in nosql</h3><p>pretty much everything in normal sqli</p><ul><li>boolean-based injection</li><li>union-esque queries</li></ul><p>it just looks slightly different</p></section><section><h3 id=demo>demo</h3></section><section><h2 id=example-payloads>example payloads</h2></section><section><h3 id=boolean-injection>boolean injection</h3><pre tabindex=0><code>&#39; OR 1=1 #
{&#34;username&#34;: {&#34;$ne&#34;: null}, &#34;password&#34;: {&#34;$ne&#34;: null}}
{&#34;username&#34;: {&#34;$ne&#34;: &#34;foo&#34;}, &#34;password&#34;: {&#34;$ne&#34;: &#34;bar&#34;}}
{&#34;username&#34;: {&#34;$gt&#34;: undefined}, &#34;password&#34;: {&#34;$gt&#34;: undefined}}
{&#34;username&#34;: {&#34;$gt&#34;:&#34;&#34;}, &#34;password&#34;: {&#34;$gt&#34;:&#34;&#34;}}
</code></pre><h3 id=boolean-based-extraction>boolean-based extraction</h3><pre tabindex=0><code>{&#34;username&#34;: {&#34;$eq&#34;: &#34;admin&#34;}, &#34;password&#34;: {&#34;$regex&#34;: &#34;^m&#34; }}
{&#34;username&#34;: {&#34;$eq&#34;: &#34;admin&#34;}, &#34;password&#34;: {&#34;$regex&#34;: &#34;^md&#34; }}
{&#34;username&#34;: {&#34;$eq&#34;: &#34;admin&#34;}, &#34;password&#34;: {&#34;$regex&#34;: &#34;^mdp&#34; }}
</code></pre></section></section></div></div><script type=text/javascript src=../../reveal-hugo/object-assign.js></script><a href=../../reveal-js/css/print/ id=print-location style=display:none></a><script type=text/javascript>var printLocationElement=document.getElementById("print-location"),link=document.createElement("link");link.rel="stylesheet",link.type="text/css",link.href=printLocationElement.href+(window.location.search.match(/print-pdf/gi)?"pdf.css":"paper.css"),document.getElementsByTagName("head")[0].appendChild(link)</script><script type=application/json id=reveal-hugo-site-params>null</script><script type=application/json id=reveal-hugo-page-params>null</script><script src=../../reveal-js/js/reveal.js></script><script type=text/javascript>function camelize(e){return e&&Object.keys(e).forEach(function(t){newK=t.replace(/(_\w)/g,function(e){return e[1].toUpperCase()}),newK!=t&&(e[newK]=e[t],delete e[t])}),e}var revealHugoDefaults={center:!0,controls:!0,history:!0,progress:!0,transition:"slide"},revealHugoSiteParams=JSON.parse(document.getElementById("reveal-hugo-site-params").innerHTML),revealHugoPageParams=JSON.parse(document.getElementById("reveal-hugo-page-params").innerHTML),options=Object.assign({},camelize(revealHugoDefaults),camelize(revealHugoSiteParams),camelize(revealHugoPageParams));Reveal.initialize(options)</script><script type=text/javascript src=../../reveal-js/plugin/markdown/marked.js></script><script type=text/javascript src=../../reveal-js/plugin/markdown/markdown.js></script><script type=text/javascript src=../../reveal-js/plugin/highlight/highlight.js></script><script type=text/javascript src=../../reveal-js/plugin/zoom-js/zoom.js></script><script type=text/javascript src=../../reveal-js/plugin/notes/notes.js></script></body></html>