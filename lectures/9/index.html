<!doctype html><html lang=en><head><meta charset=utf-8><title>9: protections</title>
<meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black-translucent"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><link rel=stylesheet href=../../reveal-js/css/reset.css><link rel=stylesheet href=../../reveal-js/css/reveal.css><link rel=stylesheet href=../../reveal-js/css/theme/black.css id=theme><link rel=stylesheet href=../../highlight-js/default.min.css></head><body><div class=reveal><div class=slides><section data-noprocess data-shortcode-slide class=center><h2 id=client-side-mitigations>client-side mitigations</h2><h3 id=6443-week9>6443 week9</h3></section><section><h3 id=pre-amble-reports>pre-amble: reports</h3><ul><li>slides are up on webcms</li><li>demos are at <a href=https://github.com/lachlan-waugh/6443>github.com/lachlan-waugh/6443</a><ul><li>go into demos/lectures and theres setup instructiong</li></ul></li></ul></section><section><section data-shortcode-section><h3 id=origin>Origin</h3><blockquote><p><span style=color:#021691>https://</span><span style=color:#fffacd>www.example.com</span><span style=color:#7fffd4>:80</span></p></blockquote><p>origin = <span style=color:#021691>scheme</span> + <span style=color:#fffacd>host</span> + <span style=color:#7fffd4>port</span></p></section><section><h3 id=site>Site</h3><blockquote><p><span style=color:#021691>http://</span><span style=color:brown>www.</span><u><span style=color:#fffacd>example</span><span style=color:#d2691e>.com</span></u><span style=color:#7fffd4>:80</span><br><span style=color:#021691>https://</span><span style=color:brown>api.</span><u><span style=color:#fffacd>example</span><span style=color:#d2691e>.com</span></u><span style=color:#7fffd4>:443</span></p></blockquote><p>site = <span style=color:#fffacd>private_domain</span> + <span style=color:#d2691e>public_suffix</span></p><ul><li><s><span style=color:#021691>scheme</span>, <span style=color:brown>subdomain</span> and <span style=color:#7fffd4>port</span></s></li></ul></section></section><section><section data-shortcode-section><h2 id=sop-same-origin-policy>SOP (Same Origin Policy)</h2><ul><li><p>blocks resource requests to/from an <em>external</em> site</p></li><li><p>&ldquo;<em>external</em>&rdquo; is based on <em>sop</em>: only requests from the same <code>origin</code> are allowed to use the resources</p></li><li><p>more secure <del><em>but how people bypassed it isn&rsquo;t xd</em></del></p></li></ul></section><section><h3 id=cross-origin-resource-sharing>cross-origin resource sharing</h3><ul><li><p>obviously sometimes you need to access resources from another origin (e.g. using images, videos)</p></li><li><p>this can be achieved if the resource owner sets certain headers on the resource (<a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Headers>more here</a>)</p></li></ul></section><section><h3 id=can-it-be-bypassed>can it be bypassed</h3><ul><li>it&rsquo;s just a browser protection</li><li>doesn&rsquo;t prevent the request (it&rsquo;ll still succeed), it prevents you from accessing the response.</li><li>would it block you if accessed it through a script?</li></ul></section></section><section><section data-shortcode-section><h2 id=mitigating-xss>mitigating xss</h2><p>basic waf stuff</p><h3 id=sanitisation>sanitisation</h3><p>stripping out unsafe tags/attributes</p><blockquote><p>&lt;script>alert(1)&lt;script> → alert(1)</p></blockquote></section><section><h3 id=encoding>encoding</h3><p>escaping control characters</p><blockquote><p>&lt;> → &amp;lt;&amp;gt;</p></blockquote></section><section><h3 id=validation>validation</h3><p>allow/block-listing of content</p><blockquote><p>block requests if you detect bad content</p></blockquote></section><section><h3 id=dont-use-raw-user-input>don&rsquo;t use raw user input</h3><ul><li><p><code>.innerHTML</code> treats content as HTML (control)</p><ul><li>use <code>.innerText</code> which treats it as data</li></ul></li><li><p>sanitize your input with a library (DOMPurify???)</p></li><li><p>don&rsquo;t write vanilla JS, use a framework.</p><ul><li>again, even if you use a framework, make sure the functions you&rsquo;re using sanitize the input</li></ul></li></ul><blockquote><p><a href=https://www.w3.org/TR/2008/WD-html5-20080610/dom.html#innerhtml0>N.B.</a></p></blockquote></section><section><h3 id=breaking-mitigations>breaking mitigations</h3><p>this relies on poorly implemented mitigations</p><ul><li>content stripped/blocked<ul><li>embed dummy characters: <code>&lt;SCRscriptIPT></code></li><li>use alternating case: <code>&lt;ScRiPt></code></li><li>different tag <code>&lt;img onerror=...></code></li><li>different event handler <code>&lt;body onload=...></code></li></ul></li></ul><p><a href=https://github.com/payloadbox/xss-payload-list>here&rsquo;s a couple more</a></p></section><section><h3 id=demo>demo</h3><ul><li><a href=http://waf.demos>waf</a></li></ul></section><section><h3 id=x-xss-protection>X-XSS-Protection</h3><ul><li>no, it&rsquo;s <a href="https://news.ycombinator.com/item?id=20472947">terrible</a><ul><li>&lsquo;First, XSS &lsquo;protection&rsquo; is about to not be implemented by most browsers&mldr;&rsquo;</li></ul></li></ul><blockquote><p>&lsquo;Worse, the XSS &lsquo;protection&rsquo; can be used to create security flaws&mldr;&rsquo; <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-XSS-Protection#vulnerabilities_caused_by_xss_filtering>example</a></p></blockquote></section><section><h3 id=an-example>an example</h3><p><code>?q=&lt;script>var productionMode = true&lt;/script></code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span>&lt;<span style=color:#f92672>script</span>&gt;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>productionMode</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>script</span>&gt;
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!-- [...] --&gt;</span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>script</span>&gt;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>window.<span style=color:#a6e22e>productionMode</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Some vulnerable debug code
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  }
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>script</span>&gt;
</span></span></code></pre></div><p> </p><p>the browser thinks that code is reflected of user input</p></section></section><section><section data-shortcode-section><h3 id=csrf-mitigations>csrf mitigations</h3><p>csrf tokens</p><p>Supply a single-use &rsquo;nonce&rsquo; value.</p><ul><li>when the page is loaded, generate the nonce</li><li>when a request is made, it must include the nonce</li><li>it&rsquo;ll be stored as a: cookie, header, <code>&lt;input></code></li></ul></section><section><h2 id=quick-demo>quick demo</h2></section><section><h3 id=breaking-mitigations>breaking mitigations</h3><ul><li>bad programming, they might be doing it wrong<ul><li>re-use a previous token (if it doesn&rsquo;t expire)</li><li>create your own?</li><li>they might not even check it.</li></ul></li></ul></section><section><h3 id=demo>demo</h3><ul><li><a href=http://bank_v0.demos>bank_v0</a></li><li><a href=http://bank.demos>bank</a></li><li><a href=http://csrf.demos>csrf</a></li></ul></section></section><section><h3 id=clickjacking-mitigations>clickjacking mitigations</h3><ul><li>csp frame-src / X-Frame-Options</li><li>same-site cookies</li><li>framebusters (<del>js magic</del>)</li></ul></section><section><section data-shortcode-section><h2 id=csp>CSP</h2><p>Content Security Policy</p><ul><li>limits where a site can load content from, e.g.<ul><li>only scripts from this website</li><li>only images from <code>https://b.com/a/path/</code></li><li>only elements with a certain nonce value</li></ul></li><li>powerful & hard to bypass (if devs were smart)</li></ul><blockquote><p>read more <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy>here</a></p></blockquote></section><section><h3 id=how-is-it-defined>how is it defined</h3><p>policy directives made of directive and value</p><p>e.g. <code>script-src: unsafe-inline</code></p><ul><li><code>script-src</code> is the <code>directive</code></li><li><code>unsafe-inline</code> is the <code>value</code></li><li>the whole thing is the policy directive</li></ul></section><section><h3 id=what-directives-are-there>what directives are there</h3><p>basically everything</p><ul><li>script-src</li><li>frame-src</li><li>img-src</li><li>object-src</li><li>default-src</li></ul></section><section><h3 id=what-values-are-there>what values are there</h3><ul><li><em>none</em>: blocks all loading</li><li><em>self</em>: only from the current origin</li><li><em>hash-X</em>: only things where their value hashes to X</li><li><em>nonce-X</em>: only things with nonce=X as an attribute</li><li><em>strict-dynamic</em>: (with hash/nonce) anything they load/create is also trusted</li><li><em>unsafe-inline</em>: e.g. &lt;script>alert(1)&lt;/script></li><li><em>unsafe-eval</em>: e.g. eval(), setTimeout()</li></ul></section><section><h3 id=where-is-it-defined>where is it defined</h3><p>http header</p><blockquote><p><code>Content-Security-Policy: &lt;policy directive></code></p></blockquote><p> </p><p>or in a tag</p><blockquote><p><code>&lt;meta http-equiv="Content-Security-Policy" content="&lt;policy directive>"></code></p></blockquote></section></section><section><section data-shortcode-section><h3 id=bypassing-csp>bypassing CSP</h3><p>ok lachlan but idc about protections I care about exploitation</p><blockquote><p>ok</p></blockquote></section><section><h3 id=how-might-you-think-to-exploit-it>how might you think to exploit it</h3><ul><li>maybe some kind of browser zeroday</li><li>hack&mldr;</li></ul><blockquote><p>nah just bad programming (again)</p></blockquote></section><section><h3 id=techniques>techniques</h3><ul><li>clrf injection/response splitting</li><li>dom clobbering (meta tag)</li></ul></section></section><section><section data-shortcode-section><h3 id=dom-clobbering>dom clobbering</h3><ul><li>discussed in more detail in the week8 extended lecture (if you&rsquo;re curious)</li><li>what if we can trick the browser into thinking our <code>&lt;meta></code> tag is the real source for csp</li><li>we could then set our own csp</li></ul></section><section><h3 id=demo>demo</h3><blockquote><p><a href=http://meta.demos>meta</a></p></blockquote></section></section><section><section data-shortcode-section><h3 id=http-response-splitting>http response splitting</h3><p>aka carriage-return line-feed injection</p><ul><li>http headers are considered &ldquo;control&rdquo;</li><li>what if user-controlled input was used in a response header?</li><li>what could you do?</li></ul></section><section><h3 id=question>question</h3><ul><li>how does a program determine:<ul><li>the end of a header?</li><li>the end of the headers/start of the body?</li></ul></li></ul></section><section><h3 id=answer>answer</h3><ul><li>headers are separated by <code>\r\n</code> (<code>CR\LF</code>)</li><li>body is separated with two <code>\r\n</code>&rsquo;s</li><li>what if our input included <code>\r\n\r\n</code>?</li></ul><p> </p><img src=../../assets/img/week8/response-splitting.png style=scale:200%></section><section><h3 id=demo>demo</h3><blockquote><p><a href=http://headers.demos>headers</a></p></blockquote></section></section><section><section data-shortcode-section><h3 id=self>&lsquo;self&rsquo;</h3><ul><li>&ldquo;The self keyword in a Content-Security-Policy header directive, &mldr; is an <strong>alias for the same origin</strong>.&rdquo;</li></ul><blockquote><p>from <a href=https://content-security-policy.com/self/>https://content-security-policy.com/self/</a></p></blockquote><blockquote><p>pretty simple</p></blockquote></section><section><h3 id=techniques>techniques</h3><ul><li>uploading files</li><li>writing to local files/jsonp</li></ul></section></section><section><section data-shortcode-section><h3 id=writing-to-local-files>writing to local files</h3><p>quick demo: <a href=http://filewriter.demos>filewriter</a></p></section><section><h3 id=an-aside-cors>an aside: CORS</h3><ul><li>sop was implemented in 1995</li><li>cors was implemented in 2006</li><li>what did people do before CORS was available?</li></ul></section><section><h3 id=jsonp>jsonp</h3><p>json with padding</p><ul><li>you can&rsquo;t load a resource from another domain</li><li>but you can load a script</li><li>so, return a script which loads the content? &#x1f9e0;</li></ul></section><section><h3 id=how-does-it-work>how does it work</h3><p>you give the jsonp endpoint a callback function</p><ul><li>how do you load the content? you run a function which takes the data as an argument.</li><li>since we&rsquo;re loading the data, we define what function is being used to load it.</li></ul><blockquote><p>if you&rsquo;re confused read up about <a href=https://developer.mozilla.org/en-US/docs/Glossary/Callback_function>callback functions</a></p></blockquote></section><section><h3 id=jsonp-example>jsonp example</h3><p>define the function using a <code>callback</code> parameter</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span><span style=color:#75715e>&lt;!-- https://melon.com/numbers?callback=load_data --&gt;</span>
</span></span><span style=display:flex><span>load_data([1, 2, 3, 4, 5])
</span></span></code></pre></div><p> </p><p>the script below will invoke <code>load_data([...])</code> with the json</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span>&lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;https://melon.com/numbers?callback=load_data&#34;</span>&gt;&lt;/<span style=color:#f92672>script</span>&gt;
</span></span></code></pre></div></section><section><h3 id=demo>demo</h3><ul><li><a href=http://jokelist.demos>jokelist</a></li><li><a href=http://bestjoke.demos>bestjoke</a></li><li><a href=http://jokes.demos>jokes</a></li></ul></section></section><section><section data-shortcode-section><h3 id=file-uploads>file uploads</h3></section><section><h3 id=demo>demo</h3><p><a href=http://upload.demos>upload</a></p></section></section><section><section data-shortcode-section><h3 id=nonce>nonce</h3><p>resources will only be trusted if they have an attribute nonce=&ldquo;nonce-X&rdquo; where X is specified in the CSP header</p><blockquote><p>read more <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/script-src#unsafe_inline_script>here</a></p></blockquote></section><section><h3 id=how-could-we-bypass-this>how could we bypass this</h3><ul><li><p>similar to csrf tokens</p></li><li><p>if they reuse tokens</p></li><li><p>if the tokens are deterministic</p></li><li><p>&mldr; but what if the tokens are secure?</p></li></ul></section><section><h3 id=based-tag><code>&lt;base>d tag</code></h3><p>specifies the base URL and/or target for all relative URLs in a document.</p><blockquote><p>read more <a href=https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base>here</a></p></blockquote></section><section><h3 id=demo>demo</h3><ul><li><a href=https://based.demos>based</a></li></ul></section><section><h3 id=how-to-resolve-this>how to resolve this</h3><ul><li>use csp better</li><li>there&rsquo;s a <code>base-uri</code> directive in CSP, specifying which locations can be specified to be the base</li></ul></section></section><section><section data-shortcode-section><h3 id=strict-dynamic>strict-dynamic</h3><p>what is it?</p><ul><li>&ldquo;the trust given to a script present in the markup, by a nonce or a hash, shall be propagated to all scripts loaded by that root script.&rdquo;</li></ul><blockquote><p>from <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/script-src#strict-dynamic>here</a></p></blockquote></section><section><h3 id=how-could-we-bypass-it>how could we bypass it?</h3><ul><li>what if we could force something that&rsquo;s validated with a hash/nonce, to create a script for us?</li><li>or even just execute code for us (as it&rsquo;s validated, it can do that)</li></ul></section></section><section><section data-shortcode-section><h3 id=script-gadgets>script gadgets</h3><ul><li>pieces of code within an application that can triggered to perform some task</li><li>they&rsquo;re legitimate pieces of javascript code, that can transform HTML injection into (js) code execution.</li><li>note: these aren&rsquo;t functions</li></ul></section><section><h3 id=how-do-html-attributes-work>how do html attributes work?</h3><ul><li>some are directly built into the browser (e.g. uploading files)</li><li>some are loaded in/defined by external libraries</li></ul></section><section><h3 id=demo>demo</h3><ul><li><a href=http://gadgets.demos>gadgets</a></li></ul></section><section><h3 id=remediations>remediations</h3><ul><li>Don&rsquo;t allow HTML injection</li><li>These aren&rsquo;t always &ldquo;vulnerabilities&rdquo;</li></ul></section></section></div></div><script type=text/javascript src=../../reveal-hugo/object-assign.js></script><a href=../../reveal-js/css/print/ id=print-location style=display:none></a><script type=text/javascript>var printLocationElement=document.getElementById("print-location"),link=document.createElement("link");link.rel="stylesheet",link.type="text/css",link.href=printLocationElement.href+(window.location.search.match(/print-pdf/gi)?"pdf.css":"paper.css"),document.getElementsByTagName("head")[0].appendChild(link)</script><script type=application/json id=reveal-hugo-site-params>null</script><script type=application/json id=reveal-hugo-page-params>null</script><script src=../../reveal-js/js/reveal.js></script><script type=text/javascript>function camelize(e){return e&&Object.keys(e).forEach(function(t){newK=t.replace(/(_\w)/g,function(e){return e[1].toUpperCase()}),newK!=t&&(e[newK]=e[t],delete e[t])}),e}var revealHugoDefaults={center:!0,controls:!0,history:!0,progress:!0,transition:"slide"},revealHugoSiteParams=JSON.parse(document.getElementById("reveal-hugo-site-params").innerHTML),revealHugoPageParams=JSON.parse(document.getElementById("reveal-hugo-page-params").innerHTML),options=Object.assign({},camelize(revealHugoDefaults),camelize(revealHugoSiteParams),camelize(revealHugoPageParams));Reveal.initialize(options)</script><script type=text/javascript src=../../reveal-js/plugin/markdown/marked.js></script><script type=text/javascript src=../../reveal-js/plugin/markdown/markdown.js></script><script type=text/javascript src=../../reveal-js/plugin/highlight/highlight.js></script><script type=text/javascript src=../../reveal-js/plugin/zoom-js/zoom.js></script><script type=text/javascript src=../../reveal-js/plugin/notes/notes.js></script></body></html>